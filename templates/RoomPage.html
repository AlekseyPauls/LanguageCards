<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Room</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.5.13/clipboard.min.js"></script>
    <script type="text/javascript" src="/static/js/jquery.i18n.properties.js"></script>

  </head>
  <body>
    <div class="dropdown language-dropdawn">
      <button id="settings" class="btn btn-primary dropdown-toggle my-btn" type="button" data-toggle="dropdown">&nbsp;</button>
      <ul id="langList" class="dropdown-menu dropdown-menu-right">
        <li><a id="labelLanguage" class="headerlabel">&nbsp;</a></li>
        <li><a id="labelView" class="headerlabel">&nbsp;</a></li>
      </ul>
    </div>
    <div class="text-center well" style="font-size: 26px;"><b id="pageName">&nbsp;</b></div>

    <div class="well container2">
      <div id="field"></div>
      <div class="text-center">
        <div class="btn-group" style="margin-top: 15px;">
          <button type="button" id="newCards" class="btn btn-success btn-block my-btn">&nbsp;</button>
          <button type="button" id="copy" class="btn btn-primary my-btn">&nbsp;</button>
          <button type="button" id="back" class="btn btn-info my-btn">&nbsp;</button>
        </div>
      </div>
    </div>
    <div id="hidden" hidden></div>

    <div id="modalCard" class="modal fade container2" role="dialog">
      <div class="vertical-alignment-helper">
        <div class="modal-dialog vertical-align-center">
          <div id="modalContent" class="modal-content" style="width: 100%;">
            <img id="modalImage" style="width: 100%; height: 100%;"></img>
            <div id="modalText" class="centered modal-text"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="modalSettings" class="modal fade container1" role="dialog">
      <div class="vertical-alignment-helper">
        <div class="modal-dialog vertical-align-center">
          <div class="modal-content" style="width: 100%; padding: 30px;">
            <div class="text-center well" style="font-size: 26px;"><b id="headerView">&nbsp;</b></div>
            <table width="100%">
              <tbody>
                <tr>
                  <td align="right" width="25%"><b id="labelCardsInRow">&nbsp;</b></td>
                  <td><input type="range" min="1" max="5" class="form-control" id="inputCardsInRow"
                    onchange="document.getElementById('cardsInRow').innerHTML = this.value;"></td>
                  <td align="left" width="10%"><b id="cardsInRow">3</b></td>
                </tr>
                <tr>
                  <td align="right" valign="top"><b id="labelCardHeight">&nbsp;</b></td>
                  <td><input type="range" min="200" max="800" step="50" class="form-control" id="inputCardHeight"
                    onchange="document.getElementById('cardHeight').innerHTML = this.value;"></td>
                  <td align="left"><b id="cardHeight">380</b></td>
                </tr>
                <tr>
                  <td align="right" valign="top"><b id="labelCardFontSize">&nbsp;</b></td>
                  <td><input type="range" min="10" max="50" step="5" class="form-control" id="inputCardFontSize"
                    onchange="document.getElementById('cardFontSize').innerHTML = this.value;"></td>
                  <td align="left"><b id="cardFontSize">20</b></td>
                </tr>
              </tbody>
            </table>
            <div class="btn-group" style="margin-top: 15px;">
              <button type="button" id="accept" class="btn btn-success btn-block my-btn">&nbsp;</button>
              <button type="button" id="default" class="btn btn-primary my-btn">&nbsp;</button>
              <button type="button" id="cancel" class="btn btn-info my-btn">&nbsp;</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      var decks_count = 0
      var socket = io('http://' + document.domain + ':' + location.port)
      var room_id = location.href.substr(location.href.lastIndexOf("/") + 1)
      $('#joinUrl').href = location.href
      updateUILang(localStorage.getItem("userLang"))

      socket.on('connect', function() {
        socket.emit('join single room', socket.id)
        socket.emit('join game room', room_id)
        socket.emit('send languages', socket.id)
        if (localStorage.getItem("cardsInRow") === "") {
          socket.emit('send room settings', socket.id)
        }
        prepareSettings()
        socket.emit('prepare field', {
          'room' : room_id,
          'client' : socket.id
        })
        socket.emit('prepare cards', {
          'room' : room_id,
          'client' : socket.id
        })
      })

      socket.on('get room settings', function(mes) {
        localStorage.setItem("cardsInRow", mes['defaultCardsInRow'])
        localStorage.setItem("cardHeight", mes['defaultCardHeight'])
        localStorage.setItem("cardFontSize", mes['defaultCardFontSize'])
        localStorage.setItem("minCardsInRow", mes['minCardsInRow'])
        localStorage.setItem("minCardHeight", mes['minCardHeight'])
        localStorage.setItem("minCardFontSize", mes['minCardFontSize'])
        localStorage.setItem("maxCardsInRow", mes['maxCardsInRow'])
        localStorage.setItem("maxCardHeight", mes['maxCardHeight'])
        localStorage.setItem("maxCardFontSize", mes['maxCardFontSize'])
        localStorage.setItem("stepCardsInRow", mes['stepCardsInRow'])
        localStorage.setItem("stepCardHeight", mes['stepCardHeight'])
        localStorage.setItem("stepCardFontSize", mes['stepCardFontSize'])
        $('#cardsInRow').text(mes['defaultCardsInRow'])
        $('#cardHeight').text(mes['defaultCardHeight'])
        $('#cardFontSize').text(mes['defaultCardFontSize'])
        $('#inputCardsInRow').attr("min", mes['minCardsInRow'])
        $('#inputCardHeight').attr("min", mes['minCardHeight'])
        $('#inputCardFontSize').attr("min", mes['minCardFontSize'])
        $('#inputCardsInRow').attr("max", mes['maxCardsInRow'])
        $('#inputCardHeight').attr("max", mes['maxCardHeight'])
        $('#inputCardFontSize').attr("max", mes['maxCardFontSize'])
        $('#inputCardsInRow').attr("step", mes['stepCardsInRow'])
        $('#inputCardHeight').attr("step", mes['stepCardHeight'])
        $('#inputCardFontSize').attr("step", mes['stepCardFontSize'])
        $('#inputCardsInRow').val(mes['defaultCardsInRow'])
        $('#inputCardHeight').val(mes['defaultCardHeight'])
        $('#inputCardFontSize').val(mes['defaultCardFontSize'])
      })

      socket.on('make field', function(count) {
        decks_count = count
        cards_in_row = localStorage.getItem("cardsInRow")
        var table = document.createElement("table")
        var table_body = document.createElement("tbody")
        table.appendChild(table_body)
        if (decks_count < cards_in_row) {
          var row = document.createElement("tr")
          table_body.appendChild(row)
          table.style = "width: " + 100 / cards_in_row * decks_count + "%; margin-left: " + (100 - 100 / cards_in_row * decks_count) / 2 + "%;"
          for (var j = 0; j < decks_count; j++) {
            row.appendChild(makeCard(j))
          }
          document.getElementById("field").appendChild(table)
        } else {
          table.style = "width: 100%;"
          for (var i = 0; i < (decks_count - decks_count % cards_in_row) / cards_in_row; i++) {
            var row = document.createElement("tr")
            table_body.appendChild(row)
            for (var j = 0; j < cards_in_row; j++) {
              row.appendChild(makeCard(i * cards_in_row + j))
            }
          }
          document.getElementById("field").appendChild(table)

          if (decks_count % cards_in_row !== 0) {
            var table = document.createElement("table")
            var table_body = document.createElement("tbody")
            table.appendChild(table_body)
            table.style = "width: " + 100 / cards_in_row * (decks_count % cards_in_row) + "%; margin-left: " +
              (100 - 100 / cards_in_row * (decks_count % cards_in_row)) / 2 + "%;"
            var row = document.createElement("tr")
            table_body.appendChild(row)
            for (var j = 0; j < decks_count % cards_in_row; j++) {
              row.appendChild(makeCard(j + decks_count - decks_count % cards_in_row))
            }
            document.getElementById("field").appendChild(table)
          }
        }
      })

      socket.on('get new cards', function(cards) {
        for (var i = 0; i < decks_count; i++) {
          var card = document.getElementById("card" + i)
          imageExists(cards[i], card, function(exists, url, place) {
            if (exists) {
              place.childNodes[0].src = url
              place.childNodes[0].style = "max-width: 100%; max-height: 100%;"
              place.childNodes[1].innerHTML = ""
            } else {
              place.childNodes[0].src = "/static/images/basecard.png"
              place.childNodes[0].style = "width: 100%; height: 100%;"
              place.childNodes[1].innerHTML = url
            }
          })
        }
      })

      socket.on('redirect', function(url) {
        window.location = url
      })

      socket.on('get languages', function(msg) {
        var langList = document.getElementById("langList")
        var listElem = document.createElement("li")
        var langElem = document.createElement("a")

        listElem = document.createElement("li")
        listElem.className = "divider"
        langList.insertBefore(listElem, langList.childNodes[2])
        listElem = document.createElement("li")
        listElem.className = "divider"
        langList.insertBefore(listElem, langList.childNodes[3])

        var i = 0;
        for (var lang in msg) {
          listElem = document.createElement("li")
          langElem = document.createElement("a")
          langElem.innerHTML = msg[lang]
          langElem.id = lang
          langElem.className = "langlabel"
          listElem.appendChild(langElem)
          langList.insertBefore(listElem, langList.childNodes[i + 3])
          i += 1;
        }
      })

      $('#copy').on('click', function() {
        var tmp = $('<input>').val(location.href).appendTo('body').select()
        document.execCommand('copy')
        tmp.remove()
      })

      $('#back').on('click', function() {
        socket.emit('leave game room', room_id)
        socket.emit('redirect to Start', socket.id)
      })

      $('#newCards').on('click', function() {
        socket.emit('send new cards', room_id)
      })

      $('#accept').on('click', function() {
        localStorage.setItem("cardsInRow", $('#cardsInRow').text())
        localStorage.setItem("cardHeight", $('#cardHeight').text())
        localStorage.setItem("cardFontSize", $('#cardFontSize').text())
        clearField()
        socket.emit('prepare field', {
          'room' : room_id,
          'client' : socket.id
        })
        socket.emit('prepare cards', {
          'room' : room_id,
          'client' : socket.id
        })
      })

      $('#default').on('click', function() {
        socket.emit('send room settings', socket.id)
        clearField()
        socket.emit('prepare field', {
          'room' : room_id,
          'client' : socket.id
        })
        socket.emit('prepare cards', {
          'room' : room_id,
          'client' : socket.id
        })
        $('#modalSettings').modal('hide')
      })

      $('#cancel').on('click', function() {
        $('#modalSettings').modal('hide')
      })

      $('#langList').on('click', 'a', function() {
        if (this.id === "labelView") {
          $('#modalSettings').modal('show')
        } else if (this.id === "labelLanguage") {
        } else {
          updateUILang(this.id)
        }
      })

      $('#modalCard').on('click', function() {
        $('#modalCard').modal('hide')
      })

      $('#field').on('click', 'div', function() {
        document.getElementById("modalImage").src = this.childNodes[0].src
        document.getElementById("modalText").innerHTML = this.childNodes[1].innerHTML
        $('#modalContent').height(window.innerHeight * 0.7 + "px")
        $('#modalCard').modal('show')
      })

      $(window).on("beforeunload", function() {
        socket.emit('leave game room', room_id)
      })

      function imageExists(url, place, callback) {
        var img = new Image()
        img.onload = function() { callback(true, url, place) }
        img.onerror = function() { callback(false, url, place) }
        if (/^(ftp|http|https):\/\/[^ "]+$/.test(url)) {
          img.src = url
        } else {
          callback(false, url, place)
        }
      }

      function makeCard(id) {
        var cell = document.createElement("td")
        var card = document.createElement("div")
        var image = document.createElement("img")
        var text = document.createElement("div")
        cell.appendChild(card)
        cell.width = 100 / cards_in_row + "%"
        cell.height = localStorage.getItem("cardHeight") + "px"
        card.className = "card"
        card.style = "height: 100%;"
        card.id = "card" + id
        card.appendChild(image)
        card.appendChild(text)
        text.className = "centered"
        text.style = "font-size: " + localStorage.getItem("cardFontSize") + "px;"
        return cell
      }

      function prepareSettings() {
        $('#inputCardsInRow').attr("min", localStorage.getItem("minCardsInRow"))
        $('#inputCardHeight').attr("min", localStorage.getItem("minCardHeight"))
        $('#inputCardFontSize').attr("min", localStorage.getItem("minCardFontSize"))
        $('#inputCardsInRow').attr("max", localStorage.getItem("maxCardsInRow"))
        $('#inputCardHeight').attr("max", localStorage.getItem("maxCardHeight"))
        $('#inputCardFontSize').attr("max", localStorage.getItem("maxCardFontSize"))
        $('#inputCardsInRow').attr("step", localStorage.getItem("stepCardsInRow"))
        $('#inputCardHeight').attr("step", localStorage.getItem("stepCardHeight"))
        $('#inputCardFontSize').attr("step", localStorage.getItem("stepCardFontSize"))
        $('#inputCardsInRow').val(localStorage.getItem("cardsInRow"))
        $('#inputCardHeight').val(localStorage.getItem("cardHeight"))
        $('#inputCardFontSize').val(localStorage.getItem("cardFontSize"))
        $('#cardsInRow').text(localStorage.getItem("cardsInRow"))
        $('#cardHeight').text(localStorage.getItem("cardHeight"))
        $('#cardFontSize').text(localStorage.getItem("cardFontSize"))
      }

      function clearField() {
        var field = document.getElementById("field")
        console.log(field.childNodes)
        for (var i = field.childNodes.length - 1; i > -1; i--) {
          field.childNodes[i].remove()
        }
      }

      function updateUILang(lang) {
        $.i18n.properties({
          async: true,
          name: 'UI',
          path: '/static/languages/',
          mode: 'both',
          language: lang,
          callback: function() {
            $('#newCards').text($.i18n.prop('button_new_cards'))
            $('#back').text($.i18n.prop('button_back'))
            $('#copy').text($.i18n.prop('button_copy_url'))
            $('#accept').text($.i18n.prop('button_accept'))
            $('#default').text($.i18n.prop('button_default'))
            $('#cancel').text($.i18n.prop('button_cancel'))
            $('#pageName').text($.i18n.prop('page_name_room'))
            $('#settings').text($.i18n.prop('label_settings'))
            $('#labelCardsInRow').text($.i18n.prop('label_cards_in_row'))
            $('#labelCardHeight').text($.i18n.prop('label_card_height'))
            $('#labelCardFontSize').text($.i18n.prop('label_card_font_size'))
            $('#labelLanguage').text($.i18n.prop('label_language') + ":")
            $('#labelView').text($.i18n.prop('label_view'))
            $('#headerView').text($.i18n.prop('label_view'))

            localStorage.setItem("userLang", lang)
            console.log("Language set")
          }
        })
      }
    </script>
  </body>
</html>